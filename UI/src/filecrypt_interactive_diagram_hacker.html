<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FileCrypt Driver - Interactive Sequence Diagram</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', 'Consolas', monospace;
            background: #1a1a1a;
            min-height: 100vh;
            color: #00ff41;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            background: #2a2a2a;
            border: 2px solid #00ff41;
            padding: 30px;
            border-radius: 0;
        }

        .header h1 {
            color: #00ff41;
            font-size: 2.5em;
            margin-bottom: 10px;
            font-weight: 700;
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
        }

        .header p {
            color: #00cc33;
            font-size: 1.1em;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }

        .controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: 2px solid #00ff41;
            border-radius: 0;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            background: #1a1a1a;
            color: #00ff41;
            font-family: 'Courier New', monospace;
        }

        .btn:hover {
            background: #2a2a2a;
        }

        .btn-primary {
            border-color: #00ff41;
        }

        .btn-secondary {
            border-color: #00cc33;
            color: #00cc33;
        }

        .btn-success {
            border-color: #00aa22;
            color: #00aa22;
        }

        .btn-info {
            border-color: #008844;
            color: #008844;
        }

        .diagram-container {
            background: #2a2a2a;
            border: 2px solid #00ff41;
            border-radius: 0;
            padding: 30px;
            margin-bottom: 30px;
            overflow-x: auto;
        }

        .info-panel {
            background: #2a2a2a;
            border: 2px solid #00ff41;
            border-radius: 0;
            padding: 25px;
            margin-bottom: 20px;
            display: none;
        }

        .info-panel.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { 
                opacity: 0; 
                transform: translateY(20px);
            }
            to { 
                opacity: 1; 
                transform: translateY(0);
            }
        }

        .info-panel h3 {
            color: #00ff41;
            margin-bottom: 15px;
            font-size: 1.4em;
            border-bottom: 2px solid #00ff41;
            padding-bottom: 8px;
            font-family: 'Courier New', monospace;
        }

        .info-panel ul {
            list-style: none;
            padding-left: 0;
        }

        .info-panel li {
            margin-bottom: 12px;
            padding: 12px;
            background: #333333;
            border: 1px solid #00ff41;
            border-left: 4px solid #00ff41;
            color: #00cc33;
        }

        .info-panel li strong {
            color: #00ff41;
        }

        .info-panel p {
            color: #00cc33;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .component-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .component-card {
            background: #333333;
            color: #00ff41;
            padding: 20px;
            border: 2px solid #00ff41;
            border-radius: 0;
            transition: all 0.3s ease;
        }

        .component-card:hover {
            transform: translateY(-5px);
            background: #3a3a3a;
        }

        .component-card h4 {
            margin-bottom: 10px;
            font-size: 1.2em;
            color: #00ff41;
            font-family: 'Courier New', monospace;
        }

        .component-card p {
            color: #00cc33;
        }

        .highlight-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .highlight-btn {
            padding: 8px 16px;
            border: 2px solid #00ff41;
            background: #1a1a1a;
            color: #00ff41;
            border-radius: 0;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .highlight-btn:hover,
        .highlight-btn.active {
            background: #2a2a2a;
        }

        .zoom-controls {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .zoom-btn {
            width: 50px;
            height: 50px;
            border-radius: 0;
            border: 2px solid #00ff41;
            background: #1a1a1a;
            color: #00ff41;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Courier New', monospace;
        }

        .zoom-btn:hover {
            background: #2a2a2a;
            transform: scale(1.1);
        }

        #mermaid-diagram {
            transition: transform 0.3s ease;
            transform-origin: center;
        }

        .flow-legend {
            background: #2a2a2a;
            color: #00ff41;
            padding: 20px;
            border: 2px solid #00ff41;
            border-radius: 0;
            margin-top: 20px;
        }

        .flow-legend h4 {
            margin-bottom: 15px;
            font-size: 1.3em;
            font-family: 'Courier New', monospace;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            color: #00cc33;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border: 1px solid #00ff41;
            margin-right: 10px;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 12px;
        }

        ::-webkit-scrollbar-track {
            background: #1a1a1a;
            border: 1px solid #00ff41;
        }

        ::-webkit-scrollbar-thumb {
            background: #00ff41;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #00cc33;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2em;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            .btn {
                width: 200px;
            }
            
            .zoom-controls {
                bottom: 20px;
                right: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê FILECRYPT DRIVER ARCHITECTURE</h1>
            <p>INTERACTIVE SEQUENCE DIAGRAM SHOWING WINDOWS KERNEL-LEVEL FILE ENCRYPTION FILTER DRIVER. 
            EXPLORE THE COMPLEX INTERACTIONS BETWEEN APPLICATIONS, FILTER MANAGER, ENCRYPTION MODULES, AND THE FILESYSTEM.</p>
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="showInfo('overview')">üìä OVERVIEW</button>
            <button class="btn btn-secondary" onclick="showInfo('components')">üîß COMPONENTS</button>
            <button class="btn btn-success" onclick="showInfo('flows')">üîÑ DATA FLOWS</button>
            <button class="btn btn-info" onclick="showInfo('security')">üõ°Ô∏è SECURITY</button>
        </div>

        <div class="highlight-controls">
            <button class="highlight-btn" onclick="highlightFlow('init')">INITIALIZATION</button>
            <button class="highlight-btn" onclick="highlightFlow('create')">FILE CREATION</button>
            <button class="highlight-btn" onclick="highlightFlow('write')">FILE WRITE</button>
            <button class="highlight-btn" onclick="highlightFlow('read')">FILE READ</button>
            <button class="highlight-btn" onclick="highlightFlow('key')">KEY MANAGEMENT</button>
            <button class="highlight-btn" onclick="clearHighlights()">CLEAR</button>
        </div>

        <!-- Info Panels -->
        <div id="overview-panel" class="info-panel">
            <h3>üéØ FILECRYPT DRIVER OVERVIEW</h3>
            <p>FILECRYPT IS A SOPHISTICATED WINDOWS KERNEL-MODE FILTER DRIVER THAT PROVIDES TRANSPARENT FILE-LEVEL ENCRYPTION. IT OPERATES AT THE FILESYSTEM LAYER, INTERCEPTING I/O OPERATIONS TO ENCRYPT DATA BEFORE IT REACHES THE DISK AND DECRYPT IT WHEN APPLICATIONS READ FILES.</p>
            
            <div class="component-grid">
                <div class="component-card">
                    <h4>üé≠ TRANSPARENT OPERATION</h4>
                    <p>APPLICATIONS REMAIN UNAWARE OF ENCRYPTION - FILES APPEAR AS NORMAL PLAINTEXT TO AUTHORIZED PROCESSES</p>
                </div>
                <div class="component-card">
                    <h4>üè¢ CHAMBER-BASED ENCRYPTION</h4>
                    <p>DIFFERENT FILE PATHS CAN USE DIFFERENT ENCRYPTION KEYS THROUGH A "CHAMBER" SYSTEM</p>
                </div>
                <div class="component-card">
                    <h4>üîê TPM INTEGRATION</h4>
                    <p>MASTER KEYS ARE SEALED USING TRUSTED PLATFORM MODULE FOR HARDWARE-LEVEL SECURITY</p>
                </div>
                <div class="component-card">
                    <h4>üì± CROSS-PLATFORM</h4>
                    <p>SUPPORTS BOTH DESKTOP AND MOBILE WINDOWS WITH DIFFERENT POLICY ENFORCEMENT</p>
                </div>
            </div>
        </div>

        <div id="components-panel" class="info-panel">
            <h3>‚öôÔ∏è SYSTEM COMPONENTS</h3>
            <ul>
                <li><strong>FILTER MANAGER:</strong> WINDOWS KERNEL COMPONENT MANAGING FILESYSTEM FILTER DRIVERS AND I/O CALLBACKS</li>
                <li><strong>FILECRYPT DRIVER:</strong> MAIN ENCRYPTION FILTER INTERCEPTING FILE OPERATIONS (CREATE, READ, WRITE)</li>
                <li><strong>SECURITY MODULE (STSEC):</strong> POLICY ENGINE HANDLING CHAMBER ASSIGNMENT, KEY DERIVATION, AND ACCESS CONTROL</li>
                <li><strong>TPM/REGISTRY:</strong> SECURE STORAGE FOR MASTER KEYS (TPM-SEALED) AND ENCRYPTION POLICIES</li>
                <li><strong>CHAMBER SYSTEM:</strong> ENCRYPTION DOMAINS LIKE "MUSICCHAMBER", "PICTURESCHAMBER", OR APP-SPECIFIC CHAMBERS</li>
                <li><strong>KEY CACHE:</strong> PERFORMANCE OPTIMIZATION STORING DERIVED ENCRYPTION KEYS IN MEMORY</li>
            </ul>
        </div>

        <div id="flows-panel" class="info-panel">
            <h3>üåä DATA FLOW PATTERNS</h3>
            <ul>
                <li><strong>FILE CREATION FLOW:</strong> PATH ANALYSIS ‚Üí SECURITY POLICY LOOKUP ‚Üí CHAMBER ASSIGNMENT ‚Üí KEY DERIVATION ‚Üí STREAM CONTEXT SETUP</li>
                <li><strong>WRITE OPERATION:</strong> DATA INTERCEPTION ‚Üí AES-CBC ENCRYPTION ‚Üí BUFFER REPLACEMENT ‚Üí ENCRYPTED STORAGE</li>
                <li><strong>READ OPERATION:</strong> ENCRYPTED DATA RETRIEVAL ‚Üí CONTEXT VALIDATION ‚Üí DECRYPTION (SYNC/ASYNC) ‚Üí PLAINTEXT DELIVERY</li>
                <li><strong>KEY MANAGEMENT:</strong> MASTER KEY (TPM) ‚Üí HMAC DERIVATION ‚Üí CHAMBER-SPECIFIC KEYS ‚Üí MEMORY CACHING</li>
                <li><strong>POLICY ENFORCEMENT:</strong> REGISTRY POLICIES ‚Üí PATH MATCHING ‚Üí SECURITY DESCRIPTOR APPLICATION ‚Üí ACCESS CONTROL</li>
            </ul>
        </div>

        <div id="security-panel" class="info-panel">
            <h3>üõ°Ô∏è SECURITY ARCHITECTURE</h3>
            <ul>
                <li><strong>HARDWARE-ROOTED TRUST:</strong> MASTER KEYS SEALED WITH TPM, ONLY ACCESSIBLE ON SAME HARDWARE PLATFORM</li>
                <li><strong>HIERARCHICAL KEY STRUCTURE:</strong> MASTER KEY ‚Üí CHAMBER PROFILE KEYS ‚Üí FILE-SPECIFIC ENCRYPTION KEYS</li>
                <li><strong>ACCESS CONTROL INTEGRATION:</strong> WINDOWS SECURITY DESCRIPTORS DETERMINE FILE ACCESS PERMISSIONS</li>
                <li><strong>MEMORY PROTECTION:</strong> ENCRYPTION KEYS ZEROED AFTER USE, SECURE MEMORY ALLOCATION PATTERNS</li>
                <li><strong>POLICY-BASED ENCRYPTION:</strong> REGISTRY-CONFIGURED POLICIES DETERMINE WHICH FILES GET ENCRYPTED</li>
                <li><strong>CHAMBER ISOLATION:</strong> DIFFERENT ENCRYPTION DOMAINS PREVENT CROSS-CONTAMINATION OF KEYS</li>
            </ul>
        </div>

        <div class="diagram-container">
            <div id="mermaid-diagram"></div>
        </div>

        <div class="flow-legend">
            <h4>üé® FLOW LEGEND</h4>
            <div class="legend-item">
                <div class="legend-color" style="background: #00ff41;"></div>
                <span>SYNCHRONOUS OPERATIONS (DIRECT CALLS)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #00cc33;"></div>
                <span>ASYNCHRONOUS OPERATIONS (QUEUED WORK)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #00aa22;"></div>
                <span>SECURITY/POLICY OPERATIONS</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #008844;"></div>
                <span>CRYPTOGRAPHIC OPERATIONS</span>
            </div>
        </div>
    </div>

    <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomIn()">+</button>
        <button class="zoom-btn" onclick="zoomOut()">‚àí</button>
        <button class="zoom-btn" onclick="resetZoom()">‚åÇ</button>
    </div>

    <script>
        let currentZoom = 1;
        let currentInfo = null;

        // Initialize Mermaid
        mermaid.initialize({ 
            startOnLoad: false,
            theme: 'dark',
            securityLevel: 'loose',
            sequence: {
                diagramMarginX: 50,
                diagramMarginY: 10,
                actorMargin: 50,
                width: 150,
                height: 65,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35
            }
        });

        // Mermaid diagram definition
        const diagramDefinition = `
sequenceDiagram
    participant App as üì± Application
    participant FM as üîß Filter Manager
    participant FC as üîê FileCrypt Driver
    participant StSec as üõ°Ô∏è Security Module
    participant TPM as üîë TPM/Registry
    participant FS as üíæ File System

    Note over FC: üöÄ Driver Initialization
    FC->>TPM: Initialize master key (StSecpGetMasterKey)
    TPM-->>FC: Sealed/Unsealed master key
    FC->>TPM: Load security policies from registry
    TPM-->>FC: Security descriptors & folder properties
    FC->>FM: Register filter callbacks

    Note over App,FS: üìÑ File Creation Flow
    App->>FM: CreateFile("\\\\Documents\\\\MyApp\\\\file.txt")
    FM->>FC: FCPreCreate()
    
    FC->>FC: Parse file path & construct full path
    FC->>StSec: StSecGetSecurityDescriptor(path)
    StSec->>StSec: Find matching security policy
    StSec->>StSec: Determine chamber ID (e.g., "MyAppChamber")
    StSec-->>FC: Security descriptor + chamber info
    
    FC->>FC: FCpAccessCheck() with security descriptor
    alt Access Denied
        FC->>FC: Modify create disposition if possible
    end
    
    FC->>FS: Forward create request
    FS-->>FC: File handle created
    
    FC->>FC: FCPostCreate()
    FC->>StSec: StSecpDeriveChamberProfileKey(chamber_id)
    StSec->>TPM: Get/derive encryption key for chamber
    TPM-->>StSec: Chamber-specific encryption key
    StSec-->>FC: Key data
    FC->>FC: Create stream context with encryption key
    FC-->>FM: Success
    FM-->>App: File handle

    Note over App,FS: ‚úçÔ∏è File Write Flow
    App->>FM: WriteFile(data)
    FM->>FC: FCPreWrite()
    
    FC->>FC: Get stream context (encryption keys)
    FC->>FC: Get volume context (sector size, etc.)
    FC->>FC: Allocate shadow buffer for encrypted data
    FC->>FC: FCpEncEncrypt() - Encrypt data with AES-CBC
    FC->>FC: Replace original buffer with encrypted buffer
    FC->>FS: Forward encrypted write
    FS-->>FC: Write complete
    
    FC->>FC: FCPostWrite() - Cleanup buffers
    FC-->>FM: Success
    FM-->>App: Write complete

    Note over App,FS: üìñ File Read Flow
    App->>FM: ReadFile()
    FM->>FC: FCPreRead()
    
    FC->>FC: Get stream context (check if encrypted)
    alt File is encrypted
        FC->>FC: Get volume context
        FC->>FC: Set up completion context
        FC->>FS: Forward read request
        FS-->>FC: Encrypted data read
        
        FC->>FC: FCPostRead()
        alt High IRQL or Large Read
            FC->>FC: Queue FCDecryptWorker() asynchronously
        else
            FC->>FC: FCDecryptWorker() immediately
        end
        
        FC->>FC: FCpEncDecrypt() - Decrypt with AES-CBC
        FC->>FC: Replace encrypted buffer with plaintext
        FC-->>FM: Decrypted data
    else
        FC->>FS: Forward read (no encryption)
        FS-->>FC: Plaintext data
        FC-->>FM: Plaintext data
    end
    FM-->>App: File data

    Note over App,FS: üíø Volume Attachment
    FM->>FC: FCInstanceSetup(new_volume)
    FC->>FC: Check volume type (NTFS/FAT/etc.)
    FC->>FC: Check if removable media or desktop/mobile OS
    alt Volume qualifies for encryption
        FC->>FC: Create volume context
        FC->>FC: FCpEncVolumeStart() - Initialize AES provider
        FC->>FC: Set volume characteristics based on flags
        FC-->>FM: Attach successful
    else
        FC-->>FM: Do not attach
    end

    Note over FC: üîê Key Management
    FC->>StSec: StSecpGetChamberProfileKey(chamber_id)
    alt Key in cache
        StSec-->>FC: Cached key
    else
        StSec->>StSec: StSecpDeriveChamberProfileKey()
        StSec->>TPM: HMAC derive from master key
        TPM-->>StSec: Derived install & data keys
        StSec->>StSec: Cache keys
        StSec-->>FC: New key
    end`;

        // Render the diagram
        async function renderDiagram() {
            const element = document.getElementById('mermaid-diagram');
            element.innerHTML = '';
            const { svg } = await mermaid.render('sequence-diagram', diagramDefinition);
            element.innerHTML = svg;
        }

        // Show info panel
        function showInfo(type) {
            // Hide all panels
            document.querySelectorAll('.info-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            // Show selected panel
            const panel = document.getElementById(`${type}-panel`);
            if (panel) {
                panel.classList.add('active');
                currentInfo = type;
            }
        }

        // Highlight specific flows
        function highlightFlow(flowType) {
            // Remove previous highlights
            clearHighlights();
            
            // Add active class to button
            document.querySelectorAll('.highlight-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            console.log(`Highlighting ${flowType} flow`);
        }

        function clearHighlights() {
            document.querySelectorAll('.highlight-btn').forEach(btn => btn.classList.remove('active'));
        }

        // Zoom controls
        function zoomIn() {
            currentZoom = Math.min(currentZoom + 0.2, 3);
            updateZoom();
        }

        function zoomOut() {
            currentZoom = Math.max(currentZoom - 0.2, 0.5);
            updateZoom();
        }

        function resetZoom() {
            currentZoom = 1;
            updateZoom();
        }

        function updateZoom() {
            const diagram = document.getElementById('mermaid-diagram');
            diagram.style.transform = `scale(${currentZoom})`;
        }

        // Initialize the page
        window.addEventListener('load', async () => {
            await renderDiagram();
            showInfo('overview');
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            switch(e.key) {
                case '1':
                    showInfo('overview');
                    break;
                case '2':
                    showInfo('components');
                    break;
                case '3':
                    showInfo('flows');
                    break;
                case '4':
                    showInfo('security');
                    break;
                case '+':
                case '=':
                    zoomIn();
                    break;
                case '-':
                    zoomOut();
                    break;
                case '0':
                    resetZoom();
                    break;
            }
        });
    </script>
</body>
</html>